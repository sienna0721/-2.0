#include "HomeSpan.h"
#include <ESP32Servo.h>
#include <SoftwareSerial.h>
#include <DFRobotDFPlayerMini.h>

const char* SETUP_CODE = "46632198";

// ===== MP3 & SoftwareSerial =====
#define MP3_RX_PIN 18 
#define MP3_TX_PIN 19 
SoftwareSerial mp3Serial(MP3_RX_PIN, MP3_TX_PIN);
DFRobotDFPlayerMini myDFPlayer;

// ===== Servo =====
#define SERVO_PIN 13
#define STOP_US 1500
#define ON_US   1250
#define OFF_US  1790
#define ON_MS   420
#define OFF_MS  420

// ===== ASR UART =====
#define ASR_RX   16    
#define ASR_TX   17    
#define ASR_BAUD 115200

const unsigned long ASR_GAP_MS  = 80;
const unsigned long DEBOUNCE_MS = 300;

Servo servo;
String asrBuf;
unsigned long asrLastByteMs = 0;
unsigned long lastTrigMs = 0;
int asrCount = 0; 

struct ServoSwitch : Service::LightBulb {
  SpanCharacteristic *power;
  bool isOn = false;

  ServoSwitch() : Service::LightBulb() {
    power = new Characteristic::On(false);
    servo.attach(SERVO_PIN, 1000, 2000);
    servo.writeMicroseconds(STOP_US);
    delay(300);
    servo.detach();
    power->setVal(false);
    isOn = false;
  }

  void playMusic(int trackNum) {
    Serial.printf(">> [語音連動] 播放音樂編號: %d\n", trackNum);
    myDFPlayer.play(trackNum); 
  }

  void spinFor(int us, int ms){
    servo.attach(SERVO_PIN, 1000, 2000);
    servo.writeMicroseconds(us);
    delay(ms);
    servo.writeMicroseconds(STOP_US);
    delay(120);
    servo.detach();
  }

  // setState 只負責動作與狀態同步
  void setState(bool on, const char* from, bool syncHomeApp){
    if(on == isOn) return;
    isOn = on;

    Serial.printf("[%s] 狀態切換: %s\n", from, isOn ? "ON" : "OFF");
    if(isOn) {
      spinFor(ON_US, ON_MS);
    } else {
      spinFor(OFF_US, OFF_MS);
    }

    if(syncHomeApp) power->setVal(isOn);
  }

  // App 控制：僅動作，無音樂
  boolean update() override {
    setState(power->getNewVal(), "HomeKit", false);
    return true;
  }

  // 語音觸發：動作 + 音樂
  void applyFromASR(bool on, int trackNum){
    if(millis() - lastTrigMs < DEBOUNCE_MS) return;
    lastTrigMs = millis();
    
    setState(on, "ASR", true);
    playMusic(trackNum); 
  }

  // ✅ 依照你的 123456 邏輯重新編寫
  void handleAsrMessage(String msg){
    msg.trim(); // 移除空白或換行
    
    if(msg.length() == 0) return;

    asrCount++; 
    Serial.println("------------------------------------");
    Serial.printf("[語音偵測 #%d] 收到指令: [%s]\n", asrCount, msg.c_str());

    // 1、3：只有語音回覆 (這裡假設播放 track 3)
    if(msg == "1"){
      Serial.println("結果: 僅語音回覆");
      playMusic(1); 
    }
    else if(msg == "3"){
      Serial.println("結果: 語音回覆");
      playMusic(3);
    }
    else if(msg == "2"){
      Serial.println("結果: 開燈 + 語音回覆");
      applyFromASR(true, 2);
    }
    // 2、6：開燈 + 語音回覆 (播放 track 1)
    else if(msg == "6"){
      Serial.println("結果: 開燈 + 語音回覆");
      applyFromASR(true, 6);
    }
    // 4、5：關燈 + 語音回覆 (播放 track 2)
    else if(msg == "4"){
      Serial.println("結果: 關燈 + 語音回覆");
      applyFromASR(false, 4);
    }
    else if(msg == "5"){
      Serial.println("結果: 關燈 + 語音回覆");
      applyFromASR(false, 5);
    }
    else if(msg == "7"){
      Serial.println("結果: 語音回覆");
      playMusic(7); 
    }
    else if(msg == "8"){
      Serial.println("結果: 語音回覆");
      playMusic(8); 
    }
    else if(msg == "9"){
      Serial.println("結果: 語音回覆");
      playMusic(9); 
    }
    else {
      Serial.println("結果: 收到未定義數字或字串");
    }
  }

  void loop() override {
    while(Serial2.available()){
      char c = (char)Serial2.read();
      if(c == '\r' || c == '\n') continue;
      if(asrBuf.length() < 64) asrBuf += c;
      asrLastByteMs = millis();
    }

    if(asrBuf.length() > 0 && (millis() - asrLastByteMs) > ASR_GAP_MS){
      handleAsrMessage(asrBuf);
      asrBuf = "";
    }
  }
};

void setup() {
  Serial.begin(115200);
  delay(500);

  // ASR 初始化
  Serial2.begin(ASR_BAUD, SERIAL_8N1, ASR_RX, ASR_TX);
  
  // MP3 初始化
  mp3Serial.begin(9600);
  if (!myDFPlayer.begin(mp3Serial)) {
    Serial.println("❌ MP3 模組未尋獲");
  } else {
    myDFPlayer.volume(30);
    Serial.println("✅ MP3 模組就緒");
  }

  homeSpan.setPairingCode(SETUP_CODE);
  homeSpan.begin(Category::Lighting, "Servo Switch");

  new SpanAccessory();
    new Service::AccessoryInformation();
      new Characteristic::Name("Servo Switch");
      new Characteristic::Manufacturer("Huang Xun Wen");
    new ServoSwitch();

  Serial.println("\n=== 系統啟動，指令過濾模式 [123456] ===");
}

void loop() {
  homeSpan.poll();
}
